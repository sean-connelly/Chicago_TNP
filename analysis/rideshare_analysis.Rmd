---
title: "Rideshare in Chicago During COVID-19"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    toc: TRUE
    toc_float: TRUE
    toc_depth: 4
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}

# Load libraries
library(tidyverse);library(lubridate);library(janitor)
library(sf);library(stplanr);library(leaflet)
library(leaflet.extras);library(tmap);library(gghighlight)
library(plotly);library(knitr);library(here)
library(kableExtra);library(viridis);library(scales)
library(hrbrthemes);library(ggthemes);library(RPostgres)
library(RPostgreSQL);library(DBI);library(config)

# Set working directory and options
setwd(here::here())
options(scipen = 999, stringsAsFactors = FALSE, dplyr.summarise.inform = FALSE)
knitr::opts_chunk$set(echo = FALSE, fig.width = 12, fig.asp = 0.618,
                      fig.align = "center", out.width = "100%")
tmap_mode("view")
tmap_options(basemaps = c(OSM = "OpenStreetMap", 
                          Light = "CartoDB.Positron",
                          Dark = "CartoDB.DarkMatter"))

```

```{r base data import}

# Connect to database
con <- RPostgres::dbConnect(RPostgres::Postgres(), 
                            host = config::get("host"),
                            port = config::get("port"),
                            dbname = config::get("dbname"),
                            user = config::get("user"), 
                            password = config::get("password"))

# Load in other data
# trips <- dbGetQuery(con, "SELECT * FROM public.trips LIMIT 100;")
# trips <- dbReadTable(con, "public.trips")

# analysis_trips <- dbGetQuery(con, "SELECT * FROM analysis.base_ytd LIMIT 100;")
# analysis_trips <- dbReadTable(con, "analysis.base_ytd")

# Drivers
# drivers <- dbGetQuery(con, "SELECT * FROM public.drivers LIMIT 100;")
# drivers <- dbReadTable(con, "public.drivers")

# Vehicles
# vehicles <- dbGetQuery(con, "SELECT * FROM public.vehicles LIMIT 100;")
# vehicles <- dbReadTable(con, "public.vehicles")

```

```{r daily trips import}

# Import data
daily_trips <- dbGetQuery(con, "SELECT * FROM analysis.daily_trips")

# Clean and tidy
daily_trips <- daily_trips %>%
  mutate("year" = year(date),
         "day" = yday(date),
         "date_x" = date %>% 
           as.character(.) %>%
           str_replace("^\\d{4}","2000") %>% 
           as_date(.),
         "weekday" = wday(date, label = TRUE),
         "trips" = as.numeric(trips)) 

```



```{r daily trips ggplot}

# Plot information
daily_trips_plot_title <- daily_trips %>%
  group_by(year) %>%
  summarize(trips = sum(trips)) %>%
  pivot_wider(everything(), names_from = "year", values_from = "trips") %>% 
  mutate("change" = `2020`-`2019`,
         "change_pct" = (change/`2019`),
         "title_text" = paste0(as.character(comma(-change)), 
                               " (", percent(change_pct), ")"))

# Daily trips YoY plot
gg_daily_trips <- daily_trips %>% 
  group_by(year) %>% 
  arrange(date_x) %>%
  mutate(trips_agg = cumsum(trips)) %>% 
  ggplot(aes(x = date_x, y = trips_agg, 
             color = as.character(year),
             text = paste0("Date: ", paste0(format(date_x, "%m/%d"),
                                            "/", as.character(year)),
                           "<br>Agg. Trips: ", scales::comma(trips_agg)))) +
  geom_line(group = 1, size = 1.5) +
  geom_vline(xintercept = as.numeric(as.Date("2000-03-21")), 
             linetype = 4, color = "black", size = 1) +
  scale_x_date(date_breaks = "1 month", 
               date_labels = "%b") +
  scale_y_continuous(labels = comma,
                     limits = c(0, NA)) +
  labs(title = paste0("Compared to 2019, rideshare trips decreased by ",
                      daily_trips_plot_title$title_text, " in 2020"),
       x = "Day of the Year", y = "Aggregate Trips",
       color = "Year") +
  scale_color_ipsum() +
  theme_ipsum()

```

```{r daily trips kable data}

# Pre/Post COVID table
daily_trips_table <- daily_trips %>%
  mutate("covid_group" = ifelse(date_x >= "2000-03-21", 
                                "Post-COVID (3/21-12/31)", 
                                "Pre-COVID (1/1-3/21)")) %>% 
  mutate("covid_group" = factor(covid_group, 
                                levels = c("Pre-COVID (1/1-3/21)", 
                                           "Post-COVID (3/21-12/31)"))) %>% 
  group_by(covid_group, year) %>%
  summarize(trips = sum(trips)) %>%
  ungroup() %>% 
  pivot_wider(names_from = "year", 
              values_from = "trips") %>% 
  adorn_totals("row") %>% 
  mutate("change" = `2020`-`2019`,
         "change_pct" = (change/`2019`)) %>% 
  mutate(across(c(`2019`, `2020`, change), comma),
         "change_pct" = percent(change_pct)) %>% 
  select("Period" = covid_group, `2019`, `2020`, 
         "Change" = change, "Change (%)" = change_pct)

```

```{r trips around stay at home ggplot}

# Trips per day around Stay-at-Home Order
gg_trips_per_day <- daily_trips %>%
  filter(month(date, label = TRUE) %in% c("Feb", "Mar")) %>% 
  group_by(year) %>% 
  arrange(date_x) %>%
  ggplot(aes(x = date_x, y = trips, color = as.character(year),
             text = paste0("Date: ", paste0(format(date_x, "%m/%d"),
                                            "/", as.character(year)),
                           "<br>Trips: ", scales::comma(trips)))) +
  geom_line(group = 1, size = 1.5) +
  geom_vline(xintercept = as.numeric(as.Date("2000-03-21")), 
             linetype = 4, color = "black", size = 1) +
  scale_x_date(date_breaks = "1 week", 
               date_labels = "%b-%d") +
  scale_y_continuous(labels = comma,
                     limits = c(0, NA)) +
  labs(title = "Trips per Day fell before the Stay-at-Home Order went into effect,\n peaking at 365,000 trips on Saturday, March 14th, 2020",
       x = "Day of the Year", y = "Trips per Day",
       color = "Year") +
  scale_color_ipsum() +
  theme_ipsum()

```

```{r monthly trips import}

# Import data
monthly_trips <- dbGetQuery(con, "SELECT * FROM analysis.monthly_trips")

# Clean and tidy
monthly_trips <- monthly_trips %>% 
  mutate("year" = year(month),
         "date_x" = floor_date(month, unit = "month") %>% 
           as.character(.) %>%
           str_replace("^\\d{4}","2000") %>% 
           as_date(.),
         "month" = month(month, label = TRUE, abbr = TRUE),
         "trips" = as.numeric(trips)) 

```

```{r monthly trips ggplot}

# Monthly trips YoY plot
gg_monthly_trips <- monthly_trips %>% 
  ggplot(aes(x = date_x, y = trips, fill = as.character(year),
             text = paste0("Date: ", paste0(format(date_x, "%M"),
                                            "/", as.character(year)),
                           "<br>Trips: ", scales::comma(trips)))) +
  geom_bar(stat = "identity", color = "black",
           position = position_dodge(width = 25), width = 20) +
  scale_x_date(date_breaks = "1 month", date_labels = "%b") +
  scale_y_continuous(labels = comma) +
  labs(title = "Trips per Month declined significantly in March, bottoming out at 1.5M in April.\nHowever, rideshare trips rebounded to 3.6M in the fall.",
       x = "Month", y = "Trips",
       fill = "Year") +
  scale_fill_ipsum() +
  theme_ipsum()

```

```{r day of week trips ggplot}

# Day of week YoY plot
gg_day_of_week_trips <- daily_trips %>%
  mutate("covid_group" = ifelse(date_x >= "2000-03-21", 
                                "Post-COVID", 
                                "Pre-COVID")) %>% 
  mutate("covid_group" = factor(covid_group, 
                                levels = c("Pre-COVID", 
                                           "Post-COVID"))) %>% 
  group_by(covid_group, year, weekday) %>%
  summarize("trips" = sum(trips)) %>%
  ungroup(weekday) %>%
  mutate("trips_pct" = trips / sum(trips)) %>% 
  ungroup() %>% 
  ggplot(aes(x = weekday, y = trips_pct, 
             fill = as.character(year),
             text = paste0("Day: ", paste0(weekday, "-", 
                                            as.character(year)),
                           "<br>Trips: ", paste0(scales::comma(trips)),
                           " (", scales::percent(trips_pct,
                                                 accuracy = 0.1), ")"))) +
  geom_bar(stat = "identity", color = "black") +
  scale_y_continuous(labels = percent) +
  labs(title = "Trips by Day of Week (%), Pre/Post-COVID",
       x = "Day of Week", y = "Trips (%)",
       fill = "Year") +
  facet_grid(covid_group ~ year) +
  scale_fill_ipsum() +
  theme_ipsum()

```

```{r hour of day trips import}

# Import data
hourly_trips <- dbGetQuery(con, "SELECT * FROM analysis.hourly_trips")

# Clean and tidy (Sunday is 0 in dow)
hourly_trips <- hourly_trips %>%
  mutate("day_of_week" = ifelse(day_of_week %in% c(6, 0),
                                "Weekend", "Weekday"),
         "hour_of_day" = paste0(hour_of_day, ":00:00"),
         "hour_of_day" = hour_of_day %>% hms(),
         "trips" = as.numeric(trips)) %>% 
  group_by(year, covid_group, day_of_week, hour_of_day) %>% 
  summarize("trips" = sum(trips)) %>% 
  ungroup(hour_of_day) %>%
  mutate("trips_pct" = trips / sum(trips)) %>% 
  ungroup()

```

```{r hour of day trips interactive plot}

# Hour of Day YoY plot
gg_hour_of_day_trips <- hourly_trips %>%
  mutate("covid_group" = factor(covid_group, 
                                levels = c("Pre-COVID", 
                                           "Post-COVID"))) %>% 
  ggplot(aes(x = hour_of_day, y = trips_pct, 
             
             linetype = day_of_week,
             group = interaction(as.character(year), 
                                 day_of_week),
             text = paste0("Hour of Day: ", hour_of_day,
                           "<br>Day of Week: ", paste0(day_of_week, "-", 
                                            as.character(year)),
                           "<br>Trips: ", paste0(scales::comma(trips)),
                           " (", scales::percent(trips_pct,
                                                 accuracy = 0.1), ")"))) +
  aes(color = as.character(year), show.guide = FALSE) +
  geom_line(size = 1.5) +
  scale_x_time(breaks = breaks_width("6 hours"), label = label_time("%l %p")) +
  scale_y_continuous(labels = percent,
                     limits = c(0, NA)) +
  labs(title = "Trips by Hour of Day (%), Pre/Post-COVID",
       x = "Hour of Day", y = "Trips (%)",
       color = "Year", linetype = "Day of Week") +
  facet_grid(covid_group ~ year) +
  scale_fill_ipsum() +
  theme_ipsum()

```

```{r trip characteristics import}

# Import data
trip_chars_avg <- dbGetQuery(con, "SELECT * FROM analysis.tnp_trip_chars") %>% 
  mutate("covid_group" = factor(covid_group, 
                                levels = c("Pre-COVID", "Post-COVID")),
         "trips" = as.numeric(trips)) %>% 
  arrange(covid_group, year)

```

```{r distance kable data}

# Average distance
# Pre/Post COVID table
trip_chars_distance <- trip_chars_avg %>%
  select(covid_group, year, trip_miles) %>% 
  pivot_wider(names_from = "year", 
              values_from = "trip_miles") %>% 
  mutate("change" = `2020`-`2019`,
         "change_pct" = (change/`2019`)) %>% 
  mutate(across(c(`2019`, `2020`, change), comma),
         "change_pct" = percent(change_pct)) %>% 
  select("Period" = covid_group, `2019`, `2020`, 
         "Change" = change, "Change (%)" = change_pct)

```

```{r duration kable data}

# Average time - minutes
# Pre/Post COVID table
trip_chars_duration <- trip_chars_avg %>%
  mutate("trip_minutes" = trip_seconds / 60) %>% 
  select(covid_group, year, trip_minutes) %>% 
  pivot_wider(names_from = "year", 
              values_from = "trip_minutes") %>% 
  mutate("change" = `2020`-`2019`,
         "change_pct" = (change/`2019`)) %>% 
  mutate(across(c(`2019`, `2020`, change), comma),
         "change_pct" = percent(change_pct)) %>% 
  select("Period" = covid_group, `2019`, `2020`, 
         "Change" = change, "Change (%)" = change_pct)

```

```{r fares import}

# Import data
fares <- dbGetQuery(con, "SELECT * FROM analysis.tnp_fares") %>% 
  mutate("covid_group" = factor(covid_group, 
                                levels = c("Pre-COVID", 
                                           "Post-COVID")),
         "trips" = as.numeric(trips))

# Distribution of fares
fares_pct <- fares %>%
  group_by(covid_group, year) %>% 
  arrange(year, covid_group, fare) %>% 
  mutate("trips_pct" = trips / sum(trips),
         "trips_pct_agg" = cumsum(trips_pct)) %>% 
  ungroup()

# 95% of trips in all periods <$30 dollars
fares_tail <- fares_pct %>% 
  group_by(covid_group, year) %>% 
  filter(trips_pct_agg < 0.95) %>% 
  arrange(desc(fare)) %>% 
  slice(1) %>% 
  ungroup()

```

```{r fares ggplot}

# Histogram
gg_fares <- fares %>%
  ggplot(aes(x = fare, y = trips, fill = as.character(year),
             text = paste0("Fare: ",scales::dollar(fare),
                           "<br>Trips: ", scales::comma(trips)))) +
  geom_bar(stat = "identity", color = "black") +
  geom_vline(data = trip_chars_avg, 
             mapping = aes(xintercept = fare),
             linetype = "dashed", size = 1) +
  # Set limit to ~$30 to eliminate long tail and focus on bulk of trips
  scale_x_continuous(labels = dollar_format(prefix = "$"),
                     limits = c(0, max(fares_tail$fare))) +
  scale_y_continuous(labels = comma) +
  labs(title = "Fare Distribution to the Nearest $2.50, Pre/Post-COVID",
       subtitle = "95% of trip fares were less than $30 in each period",
       x = "Fare", y = "Trips",
       fill = "Year") +
  facet_grid(covid_group ~ year) +
  scale_fill_ipsum() +
  theme_ipsum()

```

```{r fares kable data}

# Average fares
# Pre/Post COVID table
trip_chars_fares <- trip_chars_avg %>%
  select(covid_group, year, fare) %>% 
  pivot_wider(names_from = "year", 
              values_from = "fare") %>% 
  mutate("change" = `2020`-`2019`,
         "change_pct" = (change/`2019`)) %>% 
  mutate(across(c(`2019`, `2020`, change), dollar),
         "change_pct" = percent(change_pct)) %>% 
  select("Period" = covid_group, `2019`, `2020`, 
         "Change" = change, "Change (%)" = change_pct)

```

```{r origin-destination tracts import}

# Import data
origin_tracts_comp <- dbGetQuery(con, "SELECT * FROM analysis.pickup_tracts_comp")
destination_tracts_comp <- dbGetQuery(con, "SELECT * FROM analysis.dropoff_tracts_comp")
sf_tracts <- st_read(con, layer = "spatial_tracts")
acs_data_profiles <- dbGetQuery(con, "SELECT * FROM public.acs_data_profiles")

# Join trip data to spatial, reconfigure
# Origin-Destination
od_tracts_comp <- 
  # Origin and Destination
  full_join(origin_tracts_comp %>% 
              rename("origin_trips" = trips),
            destination_tracts_comp %>%
              rename("destination_trips" = trips),
            by = c("pickup_census_tract" = "dropoff_census_tract",
                   "year" = "year",
                   "covid_group" = "covid_group")) %>% 
  select("GEOID" = pickup_census_tract, year, covid_group,
         origin_trips, destination_trips) %>% 
  # Join to spatial data
  left_join(sf_tracts %>% select(GEOID),
            .,
            by = "GEOID") %>% 
  # Reconfigure and format
  st_as_sf() %>% 
  mutate("origin_trips" = as.numeric(origin_trips),
         "destination_trips" = as.numeric(destination_trips),
         "covid_group" = factor(covid_group, 
                                levels = c("Pre-COVID",
                                           "Post-COVID"))) %>% 
  arrange(GEOID, year, covid_group)

```

```{r essential workers definition}

# Create essential worker definition
# National averages:
#     -Essential: 23.8%
#     -Healthcare: 9.5%
# City of Chicago:
#     -Essential: 334,381 (24.5%)
#     -Healthcare: 118,787 (8.7%)
# Tract median (50th):
# Share of city employment in occupation
#     -Essential: 353 (0.11%)
#     -Healthcare: 115 (0.10%)
# Tract top 20 percent, first quintile (80th):
# Share of city employment in occupation
#     -Essential: 610 (0.18%), combined 136,540 (40.8%)
#     -Healthcare: 214 (0.18%), combined 55,398 (46.6%)

# Chicago 
acs_data_chi <- acs_data_profiles %>% 
  filter(table_name == "S2401") %>% 
  select(GEOID, variable, estimate) %>% 
  pivot_wider(names_from = "variable",
              values_from = "estimate") %>%
  select(-GEOID) %>% 
  summarize(across(where(is.numeric), ~ sum(.x, na.rm = TRUE))) %>% 
  mutate("essential" = select(., S2401_C01_015:S2401_C01_025) %>% 
           rowSums(na.rm = TRUE),
         "essential_pct" = essential / S2401_C01_001,
         "essential_non_police_fire" = select(., S2401_C01_015:S2401_C01_025,
                                              -S2401_C01_020) %>% 
           rowSums(na.rm = TRUE),
         "essential_non_police_fire_pct" = essential_non_police_fire / S2401_C01_001,
         "health_all" = select(., S2401_C01_015:S2401_C01_019) %>% 
           rowSums(na.rm = TRUE),
         "health_all_pct" = health_all / S2401_C01_001) %>% 
  rename("total" = S2401_C01_001,
         "health_pract" = S2401_C01_015,
         "health_support" = S2401_C01_019,
         "police_fire" = S2401_C01_020,
         "food_service" = S2401_C01_023,
         "custodial" = S2401_C01_024,
         "personal_service" = S2401_C01_025)

# Tract level, calculate share of city employment by occupation
acs_data_tracts <- acs_data_profiles %>% 
  filter(table_name == "S2401") %>% 
  select(GEOID, variable, estimate) %>% 
  pivot_wider(names_from = "variable",
              values_from = "estimate") %>% 
  mutate("essential" = select(., S2401_C01_015:S2401_C01_025) %>% 
           rowSums(na.rm = TRUE),
         "essential_share_chi_pct" = essential / acs_data_chi$essential,
         "essential_non_police_fire" = select(., S2401_C01_015:S2401_C01_025,
                                              -S2401_C01_020) %>% 
           rowSums(na.rm = TRUE),
         "essential_non_police_fire_pct" = essential_non_police_fire / acs_data_chi$essential_non_police_fire,
         "health_all" = select(., S2401_C01_015:S2401_C01_019) %>% 
           rowSums(na.rm = TRUE),
         "health_all_share_chi_pct" = health_all / acs_data_chi$health_all) %>%
  
  rename("total" = S2401_C01_001,
         "health_pract" = S2401_C01_015,
         "health_support" = S2401_C01_019,
         "police_fire" = S2401_C01_020,
         "food_service" = S2401_C01_023,
         "custodial" = S2401_C01_024,
         "personal_service" = S2401_C01_025)

# Essential workers by tract
essential_workers_sf <- left_join(sf_tracts %>% select(GEOID),
                                  acs_data_tracts,
                                  by = "GEOID")

```

```{r origin-destination tracts tmap data, warning=FALSE}

# Quantile map, origin
tmap_od_tracts_comp <-
  # Origin
  tm_shape(od_tracts_comp, name = "Origin") +
  tm_fill(col = "origin_trips", title = "Origin Trips",
          alpha = 0.5, style = "quantile", 
          palette = "viridis") +
  tm_borders(lwd = 0.5) +
  tm_facets(by = c("covid_group", "year"),
            free.coords = FALSE,
            drop.units = TRUE) +
  # Destination
  tm_shape(od_tracts_comp, name = "Destination") +
  tm_fill(col = "destination_trips", title = "Destination Trips",
          alpha = 0.5, style = "quantile", 
          palette = "viridis") +
  tm_borders(lwd = 0.5) +
  tm_facets(by = c("covid_group", "year"),
            free.coords = FALSE,
            drop.units = TRUE) +
  # Essential workers, non-police/fire, top 20%
  tm_shape(essential_workers_sf %>% 
             filter(essential_non_police_fire_pct >= 
                      quantile(essential_non_police_fire_pct,
                               0.80,
                               na.rm = TRUE)),
           name = "Share of Chicago Essential Workers<br>Top 20 Percent") +
  tm_borders(col = "white", lwd = 1) +
  # Layout
  tm_layout(main.title = "Rideshare Trips by Census Tract", 
            main.title.position = c("center"),
            legend.outside = TRUE,
            legend.outside.size = 1.5,
            scale = 2.75) +
  tm_view(view.legend.position = c("left", "bottom"))

```



```{r origin-destination flows import, warning=FALSE, message=FALSE}

# Import data
od_pairs_raw <- dbGetQuery(con, "SELECT * FROM analysis.trip_patterns_tracts_comp") %>% 
  mutate("covid_group" = factor(covid_group, 
                                levels = c("Pre-COVID", "Post-COVID")),
         "trips" = as.numeric(trips))

# Intra- vs inter-tract pairs
od_pairs_intra_inter <- od_pairs_raw %>% 
  mutate("intra_inter" = case_when(pickup_census_tract == 
                                     dropoff_census_tract ~
                                     "Intra (Within Same Tract)",
                                   pickup_census_tract != 
                                     dropoff_census_tract ~
                                     "Inter (Different Tract)")) %>% 
  group_by(covid_group, year, intra_inter) %>% 
  summarize("trips" = sum(trips)) %>% 
  ungroup()

```








## Executive Summary

## Rideshare Data

This analysis relies on Transportation Network Provider (TNP) data for trips, drivers, and vehicles. These datasets are published on the City of Chicago's Data Portal and updated quarterly. Please see the [GitHub repository](https://github.com/sean-connelly/Chicago_TNP) for source links and download instructions.

## Trips Over Time

### Daily Trips

```{r daily trips interactive plot}

# Interactive plot
ggplotly(gg_daily_trips, tooltip = "text") %>% 
  layout(title = list(text =  paste0(
    "Compared to 2019, rideshare trips decreased by ",
    daily_trips_plot_title$title_text, " in 2020")))

```

**This analysis uses the day that Governor Pritzker's Stay-at-Home Order went into effect (March 21st), as a way to delineate between two time frames:**

- **"Pre-COVID" (1/1-3/21) and **
- **"Post-COVID" (3/21-12/31)**

**As the data below suggest, the use of a single date to mark the onset of the pandemic is an oversimplification, but this allows for a clean comparison of rideshare trends year-over-year.** 

Prior to the Stay-at-Home Order going into effect, trips were already down by about 7 percent year-over-year. However, the bulk of the decline in rideshare occurred after the during the following 9 months. From late March 2020 onwards, only 27 million rideshare trips were taken in Chicago, about 60 million fewer trips compared to the same period in 2019.

```{r daily trips kable}

# Pre/Post COVID table
daily_trips_table %>%
  kbl() %>% 
  row_spec(3, bold = TRUE) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", 
                                      "condensed", "responsive"))

```

### Trips Around 3/21/20 Stay-at-Home Order

It is clear that behavior changed in March even before the Stay-at-Home Order, as trips per day decreased significantly after Saturday, March 14th, 2020, a full week before the Order went into effect. Note that the earlier fluctuations in January and February correspond to weekday versus weekend trips.

```{r trips around stay at home interactive plot}

# Interactive plot
ggplotly(gg_trips_per_day, tooltip = "text") %>% 
  layout(title = list(text = "Trips per Day fell before the Stay-at-Home Order went into effect,\npeaking at 365,000 trips on Saturday, March 14th, 2020"))

```

### Monthly Trips

```{r monthly trips interactive plot}

# Interactive plot
ggplotly(gg_monthly_trips, tooltip = "text") %>% 
  layout(title = list(text = "Trips per Month declined significantly in March, bottoming out at 1.5M in April.\nHowever, rideshare trips rebounded to 3.6M in the fall."))

```

### Trips by Day of Week and Hour of Day

#### Day of Week

While the number of trips were down significantly in 2020 from April to December compared to the same period in 2019, rideshare trips by day exhibited the same period across years and times periods; relatively low Monday through Wednesday before rising into the weekend and peaking Saturday.

```{r day of week trips interactive plot}

# Interactive plot
ggplotly(gg_day_of_week_trips, tooltip = "text") %>% 
  layout(title = list(text = "Trips by Day of Week (%), Pre/Post-COVID"))

```

#### Hour of Day

Breaking out trips by hour of the day, it is clear that trips were shifted over time after the Stay-at-Home order went into effect. Weekend trips by hour (dashed line) still exhibited a late night surge, but the twin peaks of the morning and evening rush during weekdays (solid line) are less noticeable. It is clear that a higher proportion of weekday trips took place during the late afternoon hours compared to the same Post-COVID period in 2019. 

```{r hour of day trips interactive plot}

# Interactive plot
#gg_hour_of_day_trips
ggplotly(gg_hour_of_day_trips, tooltip = "text") %>%
  layout(title = list(text = "Trips by Hour of Day (%), Pre/Post-COVID"))

```

## Trip Characteristics

### Distance

Prior to the Stay-at-Home Order going into effect, trips were 6.4 miles long on average, a 9 percent increase year-over-year. From late March 2020 onwards, however, the average trip distance increased to only slightly to 6.5 miles, a 1.7% increase compared to the same period in 2019.

```{r distance kable}

# Average distance - miles
# Pre/Post COVID table
trip_chars_distance %>% 
  kbl(caption = "Average Trip Distance (Mi.)") %>% 
  kable_styling(bootstrap_options = c("striped", "hover", 
                                      "condensed", "responsive"))

```

### Duration

While average trip distance increased slightly, the average trip duration fell significantly in 2020. After March 21, 2020, the average trip time was 15.9 minutes, a 15% decrease compared to the same period in 2019. This finding aligns with Manzo and Bruno's [analysis based on a sample of trips from September 2019 and September 2020](https://illinoisepi.files.wordpress.com/2021/01/ilepi-pmcr-on-demand-workers-sub-minimum-wages-final.pdf) which found a 16% decline in average trip duration due to a decrease in congestion.

```{r duration kable}

# Average duration - minutes
# Pre/Post COVID table
trip_chars_duration %>% 
  kbl(caption = "Average Trip Duration (Min.)") %>% 
  kable_styling(bootstrap_options = c("striped", "hover", 
                                      "condensed", "responsive"))

```

### Fares

The average trip fare in 2020 was about $0.80 higher in the first three months of the year compared to the same period in 2019, a 7.4% increase. However, in the period after the Stay-at-Home Order went into effect, the average trip fare in 2020 was about the same as in 2019.

```{r fares kable}

# Average fares
# Pre/Post COVID table
trip_chars_fares %>% 
  kbl(caption = "Average Trip Fare ($)") %>% 
  kable_styling(bootstrap_options = c("striped", "hover", 
                                      "condensed", "responsive"))

```

```{r fares interactive plot}

# Interactive plot
ggplotly(gg_fares, tooltip = "text") %>% 
  layout(title = list(text = paste0("Fare Distribution to the Nearest $2.50, Pre/Post-COVID", 
                                    "<br>",
                                    "<sup>",
                                    "95% of trip fares were less than $30 in each period","</sup>")))

```

## Spatial Distribution of Trips

### Origin/Destination

In the Pre-COVID period (1/1-3/21) the spatial distribution of rideshare pickups and dropoffs in 2019 and 2020 were very similar. After the Stay-at-Home Order went into effect, however, trips cratered, particularly those originating on the South, West, and Northwest Sides. Even the core area of high trip activity, roughly comprising the Loop and the North Side, shrunk in size.

**Census tracts where more than 33% of workers are essential are outlined in white, comprising the top 20 percent of tracts in the city. "Essential workers" are defined as: healthcare practitioners and technical occupations; healthcare support occupations; protective service occupations; food preparation and serving related occupations; building and grounds cleaning and maintenance occupations; and personal care and service occupations.** Neighborhoods with a high concentration of essential workers, especially those on the South and West Sides, saw a large decrease in trip dropoffs and pickups. 

```{r origin-destination tracts tmaps, fig.asp=1.75}

# Create essential worker definition
# National averages:
#     -Essential: 23.8%
#     -Healthcare: 9.5%
# City of Chicago:
#     -Essential: 334,381 (24.5%)
#     -Healthcare: 118,787 (8.7%)
# Tract median (50th):
# Share of city employment in occupation
#     -Essential: 353 (0.11%)
#     -Healthcare: 115 (0.10%)
# Tract top 20 percent, first quintile (80th):
# Share of city employment in occupation
#     -Essential: 610 (0.18%), combined 136,540 (40.8%)
#     -Healthcare: 214 (0.18%), combined 55,398 (46.6%)

# Quantile map
tmap_origin_tracts_comp
tmap_destination_tracts_comp

```

### Origin-Destination (OD) Flows

#### Flow Types

While origin and destination tracts provide a general sense of the geographic pattern of rideshare trips, they do not capture travel flows between areas. Before analyzing trip flows, it is important to distinguish between those trips that begin and end within the same tract (intra-flows) and trips that begin and end in different tracts (inter-flows). As seen in the table below, very few rideshare trips started and ended in the same tract. About 1.5% of all trips were intra-flows. This was relatively consistent across years and time periods. 

```{r od tracts intra vs inter}

# OD Pairs Intra vs Inter
# Pre/Post-COVID table
od_pairs_intra_inter %>% 
  pivot_wider(names_from = c("year", "covid_group"),
              values_from = "trips") %>% 
  adorn_totals(c("row", "col")) %>%
  adorn_percentages("col") %>%
  adorn_pct_formatting() %>%
  kbl(col.names = c("Trip Type", "2019", "2020", 
                    "2019", "2020", "Total")) %>% 
  add_header_above(c(" ", "Pre-COVID" = 2, "Post-COVID" = 2, " ")) %>%
  row_spec(3, bold = TRUE) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", 
                                      "condensed", "responsive"))

```



```{r od tracts airport data import}

# Calculate airport trips
od_pairs_airports <- od_pairs_raw %>% 
  filter(pickup_census_tract != dropoff_census_tract,
         pickup_census_tract %in% sf_tracts$GEOID,
         dropoff_census_tract %in% sf_tracts$GEOID) %>% 
  mutate("airports" = ifelse(
    pickup_census_tract %in% c("17031980000", "17031980100") | dropoff_census_tract %in% c("17031980000", "17031980100"), 
    "To or From O'Hare/Midway",
    "Other Trip")) %>% 
  group_by(covid_group, year, airports) %>% 
  summarize("trips" = sum(trips)) %>% 
  ungroup()

```

#### Airport Trips

Across the entirety of 2019 and 2020, in both Pre-COVID and Post-COVID periods, the most popular trips were from O'Hare and Midway airports to the Loop, and vice versa. Trips to or from Chicago airports alone accounted for between 6% and 9% of all rideshare trips in each analysis period. These trips are excluded from the the OD flows maps below in order to focus on neighborhood-to-neighborhood travel patterns. 

```{r od tracts airport}

# OD Pairs Airport Trips
# Pre/Post-COVID table
od_pairs_airports %>% 
  pivot_wider(names_from = c("year", "covid_group"),
              values_from = "trips") %>% 
  adorn_totals(c("row", "col")) %>%
  adorn_percentages("col") %>%
  adorn_pct_formatting() %>%
  kbl(col.names = c("Trip Type", "2019", "2020", 
                    "2019", "2020", "Total")) %>% 
  add_header_above(c(" ", "Pre-COVID" = 2, "Post-COVID" = 2, " ")) %>%
  row_spec(3, bold = TRUE) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", 
                                      "condensed", "responsive"))

```



```{r od desire lines, warning=FALSE, message=FALSE}

# Remove airport trips, make sure in Chicago
# Convert into desire lines for mapping
od_pairs_comp <- od_pairs_raw %>% 
  filter(pickup_census_tract != dropoff_census_tract,
         pickup_census_tract %in% sf_tracts$GEOID,
         dropoff_census_tract %in% sf_tracts$GEOID,
         !pickup_census_tract %in% c("17031980000", "17031980100"),
         !dropoff_census_tract %in% c("17031980000", "17031980100")) %>%
  select(pickup_census_tract, dropoff_census_tract,
         everything()) %>% 
  od2line(flow = ., zones = sf_tracts)

# Create a linewidth variable to scale desire lines
od_pairs_comp <- od_pairs_comp %>% 
  mutate("lwd" = trips / mean(od_pairs_comp$trips)) %>% 
  relocate(lwd, .after = trips)

```

#### OD Flows, 1000+ Trips

The maps below link the beginning and end of trips (excluding airport trips), where the color and thickness of desire lines vary based on the number of trips made between tracts. 

The OD pairs indicate a high concentration of trips linking the Central Business District to nearby areas like the West Loop, as well as a clear pattern of trips up and down the lakefront. After the Stay-at-Home Order went into effect, trips linking the South lakefront to the Loop and the North Side decreased dramatically.

**Neighborhoods with a high concentration of essential workers (33%+) are outlined in black.** 

```{r origin-destination tracts map, fig.asp=1.75}

# Distribution of OD trip pairs
od_pairs_pct <- od_pairs_comp %>%
  st_drop_geometry() %>% 
  group_by(covid_group, year) %>% 
  arrange(year, covid_group, desc(trips)) %>% 
  mutate("trips_pct" = trips / sum(trips),
         "trips_pct_agg" = cumsum(trips_pct)) %>% 
  ungroup()

# 90% of OD trip pairs in all periods >100 trips
od_pairs_tail <- od_pairs_pct %>% 
  group_by(covid_group, year) %>% 
  filter(trips_pct_agg < 0.90) %>% 
  arrange(trips) %>% 
  slice(1) %>% 
  ungroup()

# Restrict to valid flows
od_pairs_restrict <- od_pairs_comp %>% 
  filter(trips >= 1000)

# OD flows map (all tracts)
tm_shape(sf_tracts) +
  tm_borders(lwd = 0.5) +
  tm_shape(od_pairs_restrict,
           name = "OD Flows") +
  tm_lines(col = "trips", title = "Trips", 
           style = "quantile", palette = "viridis",
           lwd = "lwd", title.lwd = "Trips",
           scale = 40, alpha = 0.5,
           legend.lwd.show = FALSE) +
  tm_facets(by = c("covid_group", "year"), 
            free.coords = FALSE,
            drop.units = TRUE) +
  tm_shape(essential_workers_sf %>% 
             filter(essential_pct >= quantile(essential_pct,
                                              0.80,
                                              na.rm = TRUE)),
           name = "Essential Workers") +
  tm_borders(col = "black", lwd = 1) +
  tm_layout(main.title = "Rideshare Trips by Origin-Destination (OD) Pairs\nOD Pairs with 1,000+ Trips", 
            main.title.position = c("center"),
            legend.outside = FALSE,
            legend.width = 1.5,
            scale = 2.75) +
  tm_view(view.legend.position = c("left", "bottom"))

```

## Drivers



```{r, driver}
## Drivers
```

